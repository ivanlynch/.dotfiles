---
# ansible/tasks/fish_ubuntu.yml
# Asume que las variables target_fish_user, target_fish_user_home, y custom_fish_config_src
# están definidas en el playbook que importa este archivo.
# Asume 'become: true' global o en cada tarea que lo necesite.

- name: Fish | Añadir repositorio de Fish PPA (Ubuntu)
  ansible.builtin.apt_repository:
    repo: ppa:fish-shell/release-3
    state: present
    update_cache: yes
  when: ansible_distribution == "Ubuntu"
  become: true

- name: Fish | Instalar Fish shell (Ubuntu)
  ansible.builtin.apt:
    name: fish
    state: present
  when: ansible_distribution == "Ubuntu"
  become: true

- name: Fish | Asegurar que fish está en /etc/shells (Ubuntu)
  ansible.builtin.lineinfile:
    path: /etc/shells
    line: /usr/bin/fish
    state: present
    create: yes
  when: ansible_distribution == "Ubuntu"
  become: true

- name: Fish | Cambiar shell por defecto a Fish para el usuario {{ target_fish_user }} (Ubuntu)
  ansible.builtin.user:
    name: "{{ target_fish_user }}"
    shell: /usr/bin/fish
  when: ansible_distribution == "Ubuntu"
  become: true

- name: Fish | Crear directorios de configuración de Fish para el usuario (Ubuntu)
  ansible.builtin.file:
    path: "{{ target_fish_user_home }}/.config/fish/{{ item }}"
    state: directory
    owner: "{{ target_fish_user }}"
    group: "{{ target_fish_user }}"
    mode: "0755"
  loop:
    - "" # Para .config/fish
    - "conf.d"
    - "completions"
    - "functions"
  when: ansible_distribution == "Ubuntu"
  become: true

- name: Fish | Añadir ~/.local/bin al PATH de fish (vía conf.d) (Ubuntu)
  ansible.builtin.copy:
    dest: "{{ target_fish_user_home }}/.config/fish/conf.d/00_local_bin_path.fish"
    content: |
      # Añadir ~/.local/bin al PATH de fish
      if status is-interactive; or status is-login
        fish_add_path -mP $HOME/.local/bin
      end
    owner: "{{ target_fish_user }}"
    group: "{{ target_fish_user }}"
    mode: "0644"
  when: ansible_distribution == "Ubuntu"
  become: true

- name: Fish | Instalar dependencias generales (curl, git, wget) (Ubuntu)
  ansible.builtin.apt:
    name:
      - curl
      - git
      - wget
    state: present
  when: ansible_distribution == "Ubuntu"
  become: true

# --- AÑADIR LA COPIA DE config.fish AQUÍ ---
# Copiar el config.fish base ANTES de que otras tareas (starship, fzf) intenten modificarlo.
- name: Fish | Copiar configuración de Fish personalizada (config.fish) (Ubuntu)
  ansible.builtin.copy:
    src: "{{ custom_fish_config_src }}" # Definida en Dockerfile, ej: /app/ansible/files/config.fish
    dest: "{{ target_fish_user_home }}/.config/fish/config.fish"
    mode: "0644"
    owner: "{{ target_fish_user }}"
    group: "{{ target_fish_user }}"
    remote_src: yes # ¡MUY IMPORTANTE si src es una ruta dentro de la imagen!
  when: ansible_distribution == "Ubuntu"
  become: true
  register: fish_config_copy_status # Registrar para depuración

- name: Fish | Mostrar estado de la copia de config.fish (debug)
  ansible.builtin.debug:
    var: fish_config_copy_status
  when: fish_config_copy_status is defined # Mostrar solo si la tarea se ejecutó y registró algo

# Ahora importar las tareas para otras herramientas que podrían modificar config.fish
# o que dependen de la configuración base de fish.
- name: Incluir tareas de Starship
  ansible.builtin.import_tasks: ../starship/main.yml
  when: ansible_distribution == "Ubuntu"

- name: Incluir tareas de Eza
  ansible.builtin.import_tasks: ../eza/main.yml
  when: ansible_distribution == "Ubuntu"

- name: Incluir tareas de Bat
  ansible.builtin.import_tasks: ../bat/main.yml
  when: ansible_distribution == "Ubuntu"

- name: Incluir tareas de Zoxide
  ansible.builtin.import_tasks: ../zoxide/main.yml
  when: ansible_distribution == "Ubuntu"

- name: Incluir tareas de Fzf
  ansible.builtin.import_tasks: ../fzf/main.yml
  when: ansible_distribution == "Ubuntu"

- name: Incluir tareas de The Silver Searcher
  ansible.builtin.import_tasks: ../thesilversearcher/main.yml
  when: ansible_distribution == "Ubuntu"
